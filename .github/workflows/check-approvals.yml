name: Test

on:
  pull_request_target:
    types: [opened, edited, synchronize, reopened]
  pull_request_review:
    types: [submitted, dismissed]

jobs:
  check-approvals:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
      actions: write
    steps:
      - name: Check Required Approvals
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || "";
            console.log('pull_request', JSON.stringify(pr));

            // 1. Parse the PR Body to find the "Required Reviewers" section
            // We look for text between "Required Reviewers" and "Mandatory" based on your template
            const regex = /#### Required Reviewers([\s\S]*?)#### Mandatory/;
            const match = body.match(regex);

            if (!match) {
              console.log("No 'Required Reviewers' section found. Skipping check.");
              return;
            }

            // 2. Extract usernames from the list items (e.g., "- @username")
            const reviewersBlock = match[1];
            const lines = reviewersBlock.split('\n');
            const requiredUsers = lines
              .map(line => line.trim())
              .filter(line => line.startsWith('-') && line.length > 1) // Find lines starting with "-"
              .map(line => {
                // Remove the dash, whitespace, and the "@" symbol if present
                return line.replace('-', '').trim().replace('@', '');
              })
              .filter(user => !user.includes('<') && user !== ""); // Ignore placeholders like <Reviewer A>
              
            if (requiredUsers.length === 0) {
              console.log("No specific users listed in Required Reviewers.");
              return;
            }

            console.log(`Found required reviewers: ${JSON.stringify(requiredUsers)}`);

            // 3. Fetch current reviews for this PR
            const reviews = await github.paginate(github.rest.pulls.listReviews, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
            });

            const latestReviews = {};
            reviews.forEach(review => {
              if (review.user) {
                latestReviews[review.user.login] = review.state;
              }
            });

            const missingApprovals = requiredUsers.filter(user => latestReviews[user] !== 'APPROVED');

            if (missingApprovals.length > 0) {
              core.setFailed(`Waiting for approvals from: ${missingApprovals.join(', ')}`);
              return; // Stop here if failed
            }

            console.log("All required reviewers have approved!");

            // --- PART 3: THE FIX (Auto-Rerun Logic) ---
            // If we are here, it means the check passed. 
            // If this run was triggered by a REVIEW, we must check if the original PR run is stuck in "Failed".

            if (context.eventName === 'pull_request_review') {
              console.log("Review detected. Checking if the main PR workflow needs a retry...");
              
              // 1. Find the workflow runs for this specific branch/SHA
              const runs = await github.rest.actions.listWorkflowRunsForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                branch: pr.head.ref,
                event: 'pull_request_target',
                status: 'failure', // Only look for failed ones
                per_page: 1 // We only need the latest
              });

              // 2. Identify the run that matches the current commit
              // (This ensures we don't re-run an old, irrelevant build)
              const failedRun = runs.data.workflow_runs.find(run => run.head_sha === pr.head.sha);

              if (failedRun) {
                console.log(`Found failed 'pull_request_target' run (ID: ${failedRun.id}). Triggering re-run...`);
                
                await github.rest.actions.reRunWorkflow({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  run_id: failedRun.id
                });
                
                console.log("Re-run triggered successfully.");
              } else {
                console.log("No failed 'pull_request_target' runs found for this commit.");
              }
            }
