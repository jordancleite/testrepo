name: Verify Required Reviewers

on:
  pull_request_target:
    types: [opened, edited, synchronize, reopened]
  pull_request_review:
    types: [submitted, dismissed]

jobs:
  identify-reviewers:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
      actions: write
    steps:
      - name: Parse PR Body
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const response = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });

            const pr = response.data;
            const body = pr.body || "";

            // Regex to find the section between "Required Reviewers" and "Mandatory"
            const regex = /#### Required Reviewers([\s\S]*?)#### Mandatory/;
            const match = body.match(regex);

            if (!match) return [];

            const reviewersBlock = match[1];

            // Clean and extract usernames
            const users = reviewersBlock.split('\n')
              .map(line => line.trim())
              .filter(line => line.startsWith('-') && line.length > 1)
              .map(line => line.replace('-', '').trim().replace('@', ''))
              .filter(user => !user.includes('<') && user !== "");

            console.log("Identified users:", users);
            return users;

      - name: Check if required users exist
        id: check_empty
        run: |
          echo "Checking if list is empty..."
          users='${{ steps.parse.outputs.result }}'
          if [ "$users" == "[]" ]; then
            echo "List is empty."
            echo "has_users=false" >> $GITHUB_OUTPUT
          else
            echo "List is not empty."
            echo "has_users=true" >> $GITHUB_OUTPUT
          fi

      - name: Check Approval Status
        uses: actions/github-script@v7
        if: steps.check_empty.outputs.has_users == 'true'
        with:
          script: |
            const requiredUsers = ${{ steps.parse.outputs.result }};
            const prNumber = context.payload.pull_request.number;

            console.log(`Verifying approvals for: ${requiredUsers.join(', ')}`);

            // Fetch current reviews
            const reviews = await github.paginate(github.rest.pulls.listReviews, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });

            // Determine latest state per user
            const latestReviews = {};
            reviews.forEach(review => {
              if (review.user) latestReviews[review.user.login] = review.state;
            });

            // Check for missing approvals
            const missing = requiredUsers.filter(u => latestReviews[u] !== 'APPROVED');

            if (missing.length > 0) {
              core.setFailed(`Blocking Merge. Missing approvals from: ${missing.join(', ')}`);
            } else {
              console.log("Success: All required reviewers have approved.");
            }

      - name: Trigger Stale Check Re-run
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const currentEvent = context.eventName;
            const targetEvent = currentEvent === 'pull_request_review' ? 'pull_request_target' : 'pull_request_review';

            console.log(`Current event: ${currentEvent}. Looking for failed runs from: ${targetEvent}`);
            const pr = context.payload.pull_request;

            // Find the job in the opposite event type that failed
            const runs = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              branch: pr.head.ref,
              event: targetEvent, 
              status: 'failure',
              per_page: 5
            });

            // Find the run associated with the current commit
            const failedRun = runs.data.workflow_runs.find(run => run.head_sha === pr.head.sha);

            if (failedRun) {
              console.log(`Restarting failed run ID: ${failedRun.id}`);
              await github.rest.actions.reRunWorkflow({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: failedRun.id
              });
            } else {
              console.log("No stale runs found.");
            }
